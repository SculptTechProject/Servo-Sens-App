name: Checks
on: [push]

permissions:
  contents: write

jobs:
  test-lint:
    runs-on: ubuntu-24.04

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python for formatting
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Auto-format (black + isort)
        run: |
          pip install --upgrade pip
          pip install black isort
          isort backend/app
          black backend/app

      - name: Auto-commit formatted files
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ci(fmt): black+isort [skip ci]"
          file_pattern: backend/**/*.py

      - name: Create backend .env for CI
        env:
          DJANGO_SECRET_KEY: ${{ secrets.DJANGO_SECRET_KEY }}
        run: |
          cat > backend/.env <<EOF
          DEBUG=1
          DJANGO_SECRET_KEY=${DJANGO_SECRET_KEY:-dev-secret}
          DB_HOST=db
          DB_PORT=5432
          DB_NAME=dev_db
          DB_USER=devuser
          DB_PASSWORD=changeme
          REDIS_HOST=redis
          REDIS_PORT=6379
          ALLOWED_HOSTS=*
          EOF

      - name: Start infra (DB + Redis)
        run: docker compose up -d db redis

      - name: Wait for database
        run: docker compose run --rm backend sh -lc "/py/bin/python app/manage.py wait_for_db"

      - name: Test
        run: docker compose run --rm backend sh -lc "/py/bin/python app/manage.py test -v 2"

      - name: Lint
        run: docker compose run --rm backend sh -lc "/py/bin/flake8"

      - name: Teardown
        if: always()
        run: docker compose down -v
